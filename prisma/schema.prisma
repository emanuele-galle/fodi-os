generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// AUTH & RBAC
// ============================================================

model User {
  id          String    @id @default(uuid())
  username    String    @unique
  email       String    @unique
  password    String
  firstName   String
  lastName    String
  avatarUrl   String?
  phone       String?
  bio         String?
  timezone    String?   @default("Europe/Rome")
  language    String?   @default("it")
  dailyDigest Boolean   @default(true)
  onboardingCompleted Boolean @default(false)
  role          Role      @default(DEVELOPER)
  customRoleId  String?
  jobTitle      String?
  isActive      Boolean   @default(true)
  sectionAccess Json?
  lastLoginAt    DateTime?
  lastActiveAt   DateTime?
  lastIpAddress  String?
  createdAt      DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  customRole       CustomRole?      @relation(fields: [customRoleId], references: [id], onDelete: SetNull)
  refreshTokens    RefreshToken[]
  permissions      UserPermission[]
  workspaceMembers WorkspaceMember[]
  assignedTasks    Task[]          @relation("TaskAssignee")
  createdTasks     Task[]          @relation("TaskCreator")
  taskAssignments  TaskAssignment[] @relation("TaskAssignments")
  timeEntries      TimeEntry[]
  comments         Comment[]
  notifications    Notification[]
  activityLogs     ActivityLog[]
  createdQuotes    Quote[]         @relation("QuoteCreator")
  approvedQuotes   Quote[]         @relation("QuoteApprover")
  signatureRequests SignatureRequest[] @relation("SignatureRequester")
  ticketsAssigned  Ticket[]        @relation("TicketAssignee")
  ticketsCreated   Ticket[]        @relation("TicketCreator")
  clientPortal     Client?         @relation("ClientPortalUser")
  assignedLeads    Lead[]          @relation("LeadAssignee")
  ownedDeals       Deal[]          @relation("DealOwner")
  googleToken      GoogleToken?
  microsoftToken   MicrosoftToken?
  chatChannels     ChatChannel[]   @relation("ChannelCreator")
  chatMemberships  ChatMember[]
  chatMessages     ChatMessage[]
  taskAttachments      TaskAttachment[]
  projectAttachments   ProjectAttachment[]
  pushSubscriptions    PushSubscription[]
  notificationPrefs    NotificationPreference[]
  workSessions         WorkSession[]
  projectMemberships   ProjectMember[]
  digitalCard          DigitalCard?
  trustedIps           TrustedIp[]
  loginOtps            LoginOtp[]
  wikiPages            WikiPage[]
  dailyReports         DailyReport[]
  projectLinks         ProjectLink[]    @relation("ProjectLinkCreator")
  aiConversations      AiConversation[]

  workSchedule     Json?    @default("{\"1\":{\"start\":9,\"end\":18},\"2\":{\"start\":9,\"end\":18},\"3\":{\"start\":9,\"end\":18},\"4\":{\"start\":9,\"end\":18},\"5\":{\"start\":9,\"end\":18}}")

  @@index([username])
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([customRoleId])
  @@index([lastActiveAt])
  @@map("users")
}

model GoogleToken {
  id           String   @id @default(uuid())
  userId       String   @unique
  accessToken  String   @db.Text
  refreshToken String   @db.Text
  expiresAt    DateTime
  scope        String
  email        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("google_tokens")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  isRevoked Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model UserPermission {
  id         String @id @default(uuid())
  userId     String
  module     String // "crm", "erp", "pm", "kb", "content", "support", "admin"
  permission String // "read", "write", "delete", "approve", "admin"
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, module, permission])
  @@index([userId])
  @@map("user_permissions")
}

enum Role {
  ADMIN
  DIR_COMMERCIALE
  DIR_TECNICO
  DIR_SUPPORT
  COMMERCIALE
  PM
  DEVELOPER
  CONTENT
  SUPPORT
  CLIENT
}

model CustomRole {
  id                String   @id @default(uuid())
  name              String   @unique
  description       String?
  color             String?  @default("#6366f1")
  baseRole          Role     @default(DEVELOPER)
  modulePermissions Json     @default("{}")
  sectionAccess     Json     @default("{}")
  isSystem          Boolean  @default(false)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  users             User[]

  @@index([name])
  @@map("custom_roles")
}

// ============================================================
// WORKSPACES
// ============================================================

model Workspace {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  color       String   @default("#3B82F6")
  icon        String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members  WorkspaceMember[]
  projects Project[]

  @@index([slug])
  @@map("workspaces")
}

model WorkspaceMember {
  id          String        @id @default(uuid())
  workspaceId String
  userId      String
  role        WorkspaceRole @default(MEMBER)
  joinedAt    DateTime      @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_members")
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ============================================================
// CRM & ANAGRAFICA
// ============================================================

model Client {
  id           String       @id @default(uuid())
  companyName  String
  slug         String       @unique
  vatNumber    String?
  fiscalCode   String?
  pec          String?
  sdi          String?
  website      String?
  industry     String?
  source       String?
  status       ClientStatus @default(LEAD)
  notes        String?      @db.Text
  tags         String[]     @default([])
  totalRevenue Decimal      @default(0) @db.Decimal(12, 2)
  portalUserId String?      @unique
  portalUser   User?        @relation("ClientPortalUser", fields: [portalUserId], references: [id])
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  contacts        Contact[]
  interactions    Interaction[]
  projects        Project[]
  quotes          Quote[]
  tickets         Ticket[]
  documents       Document[]
  quoteTemplates  QuoteTemplate[]
  signatureRequests SignatureRequest[] @relation("SignatureClient")
  tasks           Task[]
  deals           Deal[]
  expenses        Expense[]
  incomes         Income[]
  convertedLeads  Lead[]    @relation("LeadConverted")

  @@index([status])
  @@index([slug])
  @@map("clients")
}

enum ClientStatus {
  LEAD
  PROSPECT
  ACTIVE
  INACTIVE
  CHURNED
}

model Contact {
  id        String   @id @default(uuid())
  clientId  String
  firstName String
  lastName  String
  email     String?
  phone     String?
  role      String?
  isPrimary Boolean  @default(false)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client       Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  interactions Interaction[]
  deals        Deal[]

  @@index([clientId])
  @@index([email])
  @@map("contacts")
}

model Interaction {
  id        String          @id @default(uuid())
  clientId  String
  contactId String?
  type      InteractionType
  subject   String
  content   String?         @db.Text
  date      DateTime        @default(now())
  createdAt DateTime        @default(now())

  client  Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  contact Contact? @relation(fields: [contactId], references: [id])

  @@index([clientId])
  @@index([contactId])
  @@index([date])
  @@index([clientId, date])
  @@map("interactions")
}

enum InteractionType {
  CALL
  EMAIL
  MEETING
  NOTE
  WHATSAPP
  SOCIAL
}

model Lead {
  id         String   @id @default(cuid())
  name       String
  email      String
  company    String?
  phone      String?
  service    String?
  message    String   @db.Text
  source     String   @default("website")
  status     String   @default("NEW")
  notes      String?  @db.Text
  assigneeId        String?
  assignee          User?    @relation("LeadAssignee", fields: [assigneeId], references: [id])
  convertedClientId String?
  convertedClient   Client?  @relation("LeadConverted", fields: [convertedClientId], references: [id])
  deals             Deal[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([status])
  @@index([assigneeId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([convertedClientId])
  @@map("leads")
}

model Deal {
  id                String    @id @default(uuid())
  title             String
  description       String?   @db.Text
  value             Decimal   @default(0) @db.Decimal(12, 2)
  stage             DealStage @default(QUALIFICATION)
  probability       Int       @default(50)
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  lostReason        String?
  clientId          String?
  leadId            String?
  contactId         String?
  ownerId           String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  client  Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  lead    Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)
  contact Contact? @relation(fields: [contactId], references: [id])
  owner   User     @relation("DealOwner", fields: [ownerId], references: [id])

  @@index([clientId])
  @@index([leadId])
  @@index([ownerId])
  @@index([stage])
  @@index([stage, expectedCloseDate])
  @@map("deals")
}

enum DealStage {
  QUALIFICATION
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

// ============================================================
// PROJECT MANAGEMENT
// ============================================================

model Project {
  id           String        @id @default(uuid())
  workspaceId  String
  clientId     String?
  name         String
  slug         String        @unique
  description  String?       @db.Text
  status       ProjectStatus @default(PLANNING)
  priority     Priority      @default(MEDIUM)
  startDate    DateTime?
  endDate      DateTime?
  deadline     DateTime?
  budgetAmount Decimal?      @db.Decimal(12, 2)
  budgetHours  Int?
  color        String        @default("#6366F1")
  isArchived   Boolean       @default(false)
  isInternal   Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  workspace    Workspace     @relation(fields: [workspaceId], references: [id])
  client       Client?       @relation(fields: [clientId], references: [id])
  tasks        Task[]
  milestones   Milestone[]
  documents    Document[]
  quotes       Quote[]
  tickets      Ticket[]
  chatChannels  ChatChannel[]
  folders       Folder[]
  attachments   ProjectAttachment[]
  members       ProjectMember[]
  expenses      Expense[]
  notifications Notification[]
  links         ProjectLink[]

  @@index([workspaceId])
  @@index([clientId])
  @@index([status])
  @@index([slug])
  @@index([isInternal])
  @@index([isArchived])
  @@index([workspaceId, status])
  @@index([clientId, status])
  @@index([createdAt])
  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(uuid())
  projectId String
  userId    String
  role      String   @default("MEMBER")
  joinedAt  DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_members")
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  REVIEW
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Milestone {
  id        String    @id @default(uuid())
  projectId String
  name      String
  dueDate   DateTime?
  status    String    @default("pending")
  sortOrder Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@index([projectId])
  @@map("milestones")
}

model Task {
  id             String     @id @default(uuid())
  projectId      String?
  milestoneId    String?
  parentId       String?
  assigneeId     String?
  creatorId      String
  folderId       String?
  clientId       String?
  title          String
  description    String?    @db.Text
  status         TaskStatus @default(TODO)
  priority       Priority   @default(MEDIUM)
  boardColumn    String     @default("todo")
  sortOrder      Int        @default(0)
  isPersonal     Boolean    @default(false)
  taskType       String?    @default("GENERAL")
  startDate      DateTime?
  dueDate        DateTime?
  completedAt    DateTime?
  estimatedHours   Float?
  tags             String[]   @default([])
  timerStartedAt   DateTime?
  timerUserId      String?
  microsoftTodoId    String?   @unique
  microsoftLastSync  DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  project    Project?   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  milestone  Milestone? @relation(fields: [milestoneId], references: [id])
  parent     Task?      @relation("TaskSubtasks", fields: [parentId], references: [id])
  subtasks   Task[]     @relation("TaskSubtasks")
  assignee   User?      @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator    User       @relation("TaskCreator", fields: [creatorId], references: [id])
  folder     Folder?    @relation(fields: [folderId], references: [id])
  client     Client?    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  timeEntries    TimeEntry[]
  comments       Comment[]
  assignments    TaskAssignment[]
  dependsOn      TaskDependency[] @relation("DependentTask")
  dependedOnBy   TaskDependency[] @relation("DependencyTask")
  attachments    TaskAttachment[]

  @@index([projectId])
  @@index([assigneeId])
  @@index([creatorId])
  @@index([status])
  @@index([isPersonal])
  @@index([milestoneId])
  @@index([parentId])
  @@index([boardColumn])
  @@index([folderId])
  @@index([projectId, status])
  @@index([assigneeId, status])
  @@index([creatorId, status])
  @@index([clientId])
  @@index([dueDate])
  @@index([priority])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([status, assigneeId])
  @@index([microsoftTodoId])
  @@map("tasks")
}

model TaskAssignment {
  id         String   @id @default(uuid())
  taskId     String
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation("TaskAssignments", fields: [userId], references: [id])
  role       String   @default("assignee")
  assignedAt DateTime @default(now())
  assignedBy String?

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
  @@map("task_assignments")
}

model TaskAttachment {
  id           String         @id @default(uuid())
  taskId       String
  uploadedById String
  fileName     String
  fileUrl      String
  fileSize     Int
  mimeType     String
  type         AttachmentType @default(FILE)
  linkProvider String?
  createdAt    DateTime       @default(now())

  task       Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy User @relation(fields: [uploadedById], references: [id])

  @@index([taskId])
  @@map("task_attachments")
}

model TaskDependency {
  id          String @id @default(uuid())
  taskId      String
  dependsOnId String
  type        String @default("finish_to_start")

  task      Task @relation("DependentTask", fields: [taskId], references: [id], onDelete: Cascade)
  dependsOn Task @relation("DependencyTask", fields: [dependsOnId], references: [id], onDelete: Cascade)

  @@unique([taskId, dependsOnId])
  @@map("task_dependencies")
}

model Folder {
  id          String   @id @default(uuid())
  projectId   String
  parentId    String?
  name        String
  description String?
  color       String   @default("#6366F1")
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project      Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent       Folder?              @relation("FolderSubfolders", fields: [parentId], references: [id], onDelete: Cascade)
  children     Folder[]             @relation("FolderSubfolders")
  tasks        Task[]
  attachments  ProjectAttachment[]
  chatChannels ChatChannel[]
  links        ProjectLink[]

  @@index([projectId])
  @@index([parentId])
  @@map("folders")
}

model ProjectAttachment {
  id           String         @id @default(uuid())
  projectId    String
  uploadedById String
  folderId     String?
  fileName     String
  fileUrl      String
  fileSize     Int
  mimeType     String
  driveFileId  String?
  type         AttachmentType @default(FILE)
  linkProvider String?
  createdAt    DateTime       @default(now())

  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedBy User    @relation(fields: [uploadedById], references: [id])
  folder     Folder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([folderId])
  @@map("project_attachments")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  CANCELLED
}

model TimeEntry {
  id          String   @id @default(uuid())
  userId      String
  taskId      String?
  projectId   String?
  date        DateTime @db.Date
  hours       Float
  description String?
  billable    Boolean  @default(true)
  hourlyRate  Decimal? @db.Decimal(8, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User  @relation(fields: [userId], references: [id])
  task Task? @relation(fields: [taskId], references: [id])

  @@index([userId])
  @@index([taskId])
  @@index([date])
  @@index([userId, date])
  @@map("time_entries")
}

model WorkSession {
  id            String    @id @default(uuid())
  userId        String
  clockIn       DateTime  @default(now())
  clockOut      DateTime?
  lastHeartbeat DateTime  @default(now())
  durationMins  Int?
  notes         String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([clockIn])
  @@index([userId, clockIn])
  @@map("work_sessions")
}

// ============================================================
// ERP & FINANCE
// ============================================================

model Quote {
  id                 String      @id @default(uuid())
  clientId           String
  projectId          String?
  creatorId          String
  approverId         String?
  templateId         String?
  number             String      @unique
  title              String
  content            Json?
  status             QuoteStatus @default(DRAFT)
  subtotal           Decimal     @db.Decimal(12, 2)
  taxRate            Decimal     @default(22) @db.Decimal(5, 2)
  taxAmount          Decimal     @db.Decimal(12, 2)
  total              Decimal     @db.Decimal(12, 2)
  discount           Decimal     @default(0) @db.Decimal(12, 2)
  validUntil         DateTime?
  sentAt             DateTime?
  approvedAt         DateTime?
  rejectedAt         DateTime?
  notes              String?     @db.Text
  clientApproval     Boolean?
  clientApprovalDate DateTime?
  clientApprovalNote String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  client    Client          @relation(fields: [clientId], references: [id])
  project   Project?        @relation(fields: [projectId], references: [id])
  creator   User            @relation("QuoteCreator", fields: [creatorId], references: [id])
  approver  User?           @relation("QuoteApprover", fields: [approverId], references: [id])
  template  QuoteTemplate?  @relation("QuoteFromTemplate", fields: [templateId], references: [id])
  lineItems QuoteLineItem[]

  @@index([clientId])
  @@index([status])
  @@index([number])
  @@index([templateId])
  @@index([creatorId])
  @@index([projectId])
  @@index([clientId, status])
  @@index([createdAt])
  @@map("quotes")
}

model QuoteLineItem {
  id          String  @id @default(uuid())
  quoteId     String
  description String
  quantity    Float   @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(12, 2)
  sortOrder   Int     @default(0)

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@map("quote_line_items")
}

enum QuoteStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  EXPIRED
  INVOICED
}

model Expense {
  id          String   @id @default(uuid())
  category    String
  description String
  amount      Decimal  @db.Decimal(10, 2)
  date        DateTime @db.Date
  receipt     String?
  clientId    String?
  projectId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Abbonamento / Ricorrenza
  isRecurring     Boolean   @default(false)
  frequency       String?   // monthly, quarterly, yearly, custom
  nextDueDate     DateTime? @db.Date
  endDate         DateTime? @db.Date
  autoRenew       Boolean   @default(true)
  status          String    @default("active") // active, paused, cancelled, expired
  provider        String?
  notes           String?
  parentExpenseId String?
  parentExpense   Expense?  @relation("ExpenseChildren", fields: [parentExpenseId], references: [id])
  childExpenses   Expense[] @relation("ExpenseChildren")
  client          Client?   @relation(fields: [clientId], references: [id])
  project         Project?  @relation(fields: [projectId], references: [id])

  // Contabilità avanzata
  isPaid           Boolean         @default(true)
  supplierName     String?
  bankAccountId    String?
  businessEntityId String?
  vatRate          String?
  deductibility    String?
  netAmount        Decimal?        @db.Decimal(12, 2)
  vatDeductible    Decimal?        @db.Decimal(12, 2)
  invoiceNumber    String?
  dueDate          DateTime?       @db.Date
  paymentMethod    String?

  bankAccount      BankAccount?    @relation(fields: [bankAccountId], references: [id])
  businessEntity   BusinessEntity? @relation(fields: [businessEntityId], references: [id])

  @@index([date])
  @@index([category])
  @@index([isRecurring])
  @@index([nextDueDate])
  @@index([status])
  @@index([clientId])
  @@index([projectId])
  @@index([isPaid])
  @@index([bankAccountId])
  @@map("expenses")
}

// ============================================================
// CONTABILITÀ AVANZATA
// ============================================================

model BankAccount {
  id          String   @id @default(uuid())
  name        String
  type        String   @default("bank") // bank, credit_card, cash
  icon        String?
  balance     Decimal  @default(0) @db.Decimal(12, 2)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  incomes           Income[]
  expenses          Expense[]
  transfersFrom     BankTransfer[] @relation("TransferFrom")
  transfersTo       BankTransfer[] @relation("TransferTo")
  recurringInvoices RecurringInvoice[]

  @@map("bank_accounts")
}

model BusinessEntity {
  id        String   @id @default(uuid())
  name      String
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)

  incomes           Income[]
  expenses          Expense[]
  recurringInvoices RecurringInvoice[]

  @@map("business_entities")
}

model Income {
  id               String          @id @default(uuid())
  isPaid           Boolean         @default(false)
  clientName       String
  date             DateTime        @db.Date
  bankAccountId    String?
  businessEntityId String?
  category         String
  amount           Decimal         @db.Decimal(12, 2)
  vatRate          String          @default("22")
  netAmount        Decimal?        @db.Decimal(12, 2)
  vatAmount        Decimal?        @db.Decimal(12, 2)
  invoiceNumber    String?
  dueDate          DateTime?       @db.Date
  paymentMethod    String?
  notes            String?
  clientId         String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  bankAccount      BankAccount?    @relation(fields: [bankAccountId], references: [id])
  businessEntity   BusinessEntity? @relation(fields: [businessEntityId], references: [id])
  client           Client?         @relation(fields: [clientId], references: [id])

  @@index([date])
  @@index([isPaid])
  @@index([category])
  @@index([bankAccountId])
  @@map("incomes")
}

model BankTransfer {
  id            String       @id @default(uuid())
  date          DateTime     @db.Date
  operation     String
  fromAccountId String
  toAccountId   String
  amount        Decimal      @db.Decimal(12, 2)
  notes         String?
  createdAt     DateTime     @default(now())

  fromAccount   BankAccount  @relation("TransferFrom", fields: [fromAccountId], references: [id])
  toAccount     BankAccount  @relation("TransferTo", fields: [toAccountId], references: [id])

  @@index([date])
  @@map("bank_transfers")
}

model ProfitGoal {
  id        String   @id @default(uuid())
  year      Int
  month     Int
  amount    Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([year, month])
  @@index([year])
  @@map("profit_goals")
}

model RecurringInvoice {
  id               String          @id @default(uuid())
  description      String
  category         String
  supplierName     String?
  amount           Decimal         @db.Decimal(12, 2)
  frequency        String
  firstDate        DateTime        @db.Date
  lastPaidDate     DateTime?       @db.Date
  nextDueDate      DateTime?       @db.Date
  totalPaid        Decimal         @default(0) @db.Decimal(12, 2)
  totalDue         Decimal         @default(0) @db.Decimal(12, 2)
  isActive         Boolean         @default(true)
  notes            String?
  bankAccountId    String?
  businessEntityId String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  bankAccount      BankAccount?    @relation(fields: [bankAccountId], references: [id])
  businessEntity   BusinessEntity? @relation(fields: [businessEntityId], references: [id])

  @@index([isActive])
  @@index([nextDueDate])
  @@map("recurring_invoices")
}

model AccountingCategory {
  id        String  @id @default(uuid())
  name      String
  type      String  // "income" | "expense"
  icon      String?
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  @@unique([name, type])
  @@map("accounting_categories")
}

model VatRate {
  id          String  @id @default(uuid())
  rate        Decimal @db.Decimal(5, 2)
  label       String
  code        String  @unique
  description String?
  isActive    Boolean @default(true)
  isDefault   Boolean @default(false)
  sortOrder   Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("vat_rates")
}

// ============================================================
// SUPPORT
// ============================================================

model Ticket {
  id          String       @id @default(uuid())
  clientId    String
  projectId   String?
  creatorId   String
  assigneeId  String?
  number      String       @unique
  subject     String
  description String       @db.Text
  status      TicketStatus @default(OPEN)
  priority    Priority     @default(MEDIUM)
  category    String       @default("general")
  resolvedAt  DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  client   Client   @relation(fields: [clientId], references: [id])
  project  Project? @relation(fields: [projectId], references: [id])
  creator  User     @relation("TicketCreator", fields: [creatorId], references: [id])
  assignee User?    @relation("TicketAssignee", fields: [assigneeId], references: [id])
  comments Comment[]

  @@index([clientId])
  @@index([assigneeId])
  @@index([status])
  @@index([number])
  @@index([creatorId])
  @@index([projectId])
  @@index([clientId, status])
  @@index([createdAt])
  @@map("tickets")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CLIENT
  RESOLVED
  CLOSED
}

// ============================================================
// CROSS-CUTTING
// ============================================================

model Comment {
  id         String   @id @default(uuid())
  authorId   String
  taskId     String?
  ticketId   String?
  content    String   @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  author   User      @relation(fields: [authorId], references: [id])
  task     Task?     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  ticket   Ticket?   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([ticketId])
  @@index([authorId])
  @@index([createdAt])
  @@map("comments")
}

model Document {
  id              String         @id @default(uuid())
  clientId        String?
  projectId       String?
  name            String
  fileUrl         String
  fileSize        Int?
  mimeType        String?
  driveFileId     String?
  type            AttachmentType @default(FILE)
  linkProvider    String?
  category        String         @default("general")
  isClientVisible Boolean        @default(false)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  client  Client?  @relation(fields: [clientId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])

  @@index([clientId])
  @@index([projectId])
  @@index([category])
  @@index([isClientVisible])
  @@map("documents")
}

model Notification {
  id            String   @id @default(uuid())
  userId        String
  type          String
  title         String
  message       String
  link          String?
  isRead        Boolean  @default(false)
  metadata      Json?
  projectId     String?
  groupKey      String?
  groupCount    Int      @default(1)
  lastActorName String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([projectId])
  @@index([userId, groupKey])
  @@map("notifications")
}

model NotificationPreference {
  id      String  @id @default(uuid())
  userId  String
  type    String
  channel String  @default("in_app")
  enabled Boolean @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, channel])
  @@index([userId])
  @@map("notification_preferences")
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@map("push_subscriptions")
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String
  action     String
  entityType String
  entityId   String
  metadata   Json?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@map("activity_logs")
}

// ============================================================
// DAILY REPORTS
// ============================================================

model DailyReport {
  id        String   @id @default(uuid())
  userId    String
  date      DateTime @db.Date
  pdfUrl    String
  summary   Json
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@index([userId, date])
  @@map("daily_reports")
}

// ============================================================
// TEAM CHAT
// ============================================================

model ChatChannel {
  id          String      @id @default(uuid())
  name        String
  slug        String      @unique
  description String?
  type        ChannelType @default(PUBLIC)
  projectId   String?
  folderId    String?
  createdById String
  isArchived  Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  createdBy User          @relation("ChannelCreator", fields: [createdById], references: [id])
  project   Project?      @relation(fields: [projectId], references: [id])
  folder    Folder?       @relation(fields: [folderId], references: [id], onDelete: SetNull)
  members   ChatMember[]
  messages  ChatMessage[]

  @@index([slug])
  @@index([type])
  @@index([createdById])
  @@index([projectId])
  @@index([folderId])
  @@map("chat_channels")
}

model ChatMember {
  id         String         @id @default(uuid())
  channelId  String
  userId     String
  role       ChatMemberRole @default(MEMBER)
  lastReadAt DateTime?
  joinedAt   DateTime       @default(now())

  channel ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@index([channelId])
  @@index([userId])
  @@map("chat_members")
}

model ChatMessage {
  id        String          @id @default(uuid())
  channelId String
  authorId  String
  content   String          @db.Text
  type      ChatMessageType @default(TEXT)
  metadata  Json?
  editedAt  DateTime?
  deletedAt DateTime?
  createdAt DateTime        @default(now())

  channel ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  author  User        @relation(fields: [authorId], references: [id])

  @@index([channelId, createdAt])
  @@index([authorId])
  @@map("chat_messages")
}

enum ChannelType {
  PUBLIC
  PRIVATE
  DIRECT
  PROJECT
}

enum ChatMemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum ChatMessageType {
  TEXT
  SYSTEM
  FILE_LINK
  EXTERNAL_LINK
}

enum AttachmentType {
  FILE
  EXTERNAL
}

model CompanyProfile {
  id             String  @id @default(cuid())
  ragioneSociale String
  partitaIva     String
  codiceFiscale  String?
  indirizzo      String
  cap            String
  citta          String
  provincia      String  @db.VarChar(2)
  nazione        String  @default("IT")
  regimeFiscale  String  @default("RF01")
  iban           String?
  pec            String?
  telefono       String?
  email          String?
  logoUrl        String?
  siteUrl        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("company_profiles")
}

// ============================================================
// QUOTE TEMPLATES (FASE 1)
// ============================================================

model QuoteTemplate {
  id               String   @id @default(uuid())
  name             String
  slug             String   @unique
  description      String?
  isGlobal         Boolean  @default(true)
  clientId         String?
  creatorId        String
  logoUrl          String?
  primaryColor     String   @default("#3B82F6")
  secondaryColor   String   @default("#1E293B")
  headerHtml       String?  @db.Text
  footerHtml       String?  @db.Text
  sections         Json?    // [{title, content, sortOrder}]
  numberPrefix     String   @default("Q")
  numberFormat     String   @default("{PREFIX}-{YYYY}-{NNN}")
  defaultTaxRate   Decimal  @default(22) @db.Decimal(5, 2)
  defaultDiscount  Decimal  @default(0) @db.Decimal(12, 2)
  defaultNotes     String?  @db.Text
  defaultValidDays Int      @default(30)
  termsAndConditions String? @db.Text
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  client           Client?  @relation(fields: [clientId], references: [id])
  lineItems        QuoteTemplateLineItem[]
  quotes           Quote[]  @relation("QuoteFromTemplate")

  @@index([clientId])
  @@index([isGlobal])
  @@map("quote_templates")
}

model QuoteTemplateLineItem {
  id          String  @id @default(uuid())
  templateId  String
  description String
  quantity    Float   @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  sortOrder   Int     @default(0)

  template    QuoteTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("quote_template_line_items")
}

// ============================================================
// SIGNATURE / OTP (FASE 3)
// ============================================================

model SignatureRequest {
  id              String    @id @default(uuid())
  documentType    String    // "QUOTE" | "CONTRACT" | "CUSTOM"
  documentId      String?
  documentTitle   String
  documentUrl     String    // PDF originale su MinIO
  signedPdfUrl    String?   // PDF firmato
  requesterId     String
  signerName      String
  signerEmail     String
  signerPhone     String?
  signerClientId  String?
  status          String    @default("PENDING") // PENDING, OTP_SENT, SIGNED, DECLINED, EXPIRED, CANCELLED
  expiresAt       DateTime
  signedAt        DateTime?
  declineReason   String?
  message         String?   @db.Text
  accessToken     String    @unique
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  requester       User      @relation("SignatureRequester", fields: [requesterId], references: [id])
  signerClient    Client?   @relation("SignatureClient", fields: [signerClientId], references: [id])
  otpAttempts     SignatureOtp[]
  auditTrail      SignatureAudit[]

  @@index([status])
  @@index([signerEmail])
  @@index([accessToken])
  @@index([requesterId])
  @@index([signerClientId])
  @@index([createdAt])
  @@map("signature_requests")
}

model SignatureOtp {
  id          String   @id @default(uuid())
  requestId   String
  otpHash     String   // bcrypt hash, MAI in chiaro
  channel     String   @default("email")
  sentTo      String
  expiresAt   DateTime
  isUsed      Boolean  @default(false)
  attempts    Int      @default(0)
  maxAttempts Int      @default(5)
  createdAt   DateTime @default(now())

  request     SignatureRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@map("signature_otps")
}

model SignatureAudit {
  id        String   @id @default(uuid())
  requestId String
  action    String   // "created", "otp_sent", "otp_verified", "signed", "declined", "viewed"
  ipAddress String?
  userAgent String?  @db.Text
  metadata  Json?
  createdAt DateTime @default(now())

  request   SignatureRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@map("signature_audits")
}

// ============================================================
// WIZARD COMMERCIALE (FASE 4)
// ============================================================

model WizardTemplate {
  id                 String   @id @default(uuid())
  name               String
  slug               String   @unique
  description        String?  @db.Text
  category           String   @default("general")
  isSystem           Boolean  @default(false)
  status             String   @default("DRAFT") // DRAFT, PUBLISHED, ARCHIVED
  creatorId          String
  allowSaveProgress  Boolean  @default(true)
  showProgressBar    Boolean  @default(true)
  completionMessage  String?  @db.Text
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  steps              WizardStep[]
  submissions        WizardSubmission[]

  @@index([category])
  @@index([status])
  @@index([slug])
  @@map("wizard_templates")
}

model WizardStep {
  id          String  @id @default(uuid())
  templateId  String
  title       String
  description String?
  sortOrder   Int     @default(0)
  condition   Json?   // {fieldId, operator, value}

  template    WizardTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  fields      WizardField[]

  @@index([templateId])
  @@map("wizard_steps")
}

model WizardField {
  id           String  @id @default(uuid())
  stepId       String
  label        String
  name         String
  type         String  @default("TEXT") // TEXT, TEXTAREA, EMAIL, PHONE, NUMBER, SELECT, MULTISELECT, RADIO, CHECKBOX, DATE, FILE, RATING, SCALE
  placeholder  String?
  helpText     String?
  isRequired   Boolean @default(false)
  sortOrder    Int     @default(0)
  options      Json?   // [{label, value}] per SELECT/RADIO
  validation   Json?   // {min, max, minLength, maxLength, pattern}
  defaultValue String?
  condition    Json?
  crmMapping   String? // "client.companyName", "contact.email", ecc.

  step         WizardStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([stepId])
  @@map("wizard_fields")
}

model WizardSubmission {
  id             String    @id @default(uuid())
  templateId     String
  clientId       String?
  leadId         String?
  submitterId    String?
  submitterName  String?
  submitterEmail String?
  status         String    @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, ABANDONED
  currentStep    Int       @default(0)
  answers        Json      @default("{}")
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  template       WizardTemplate @relation(fields: [templateId], references: [id])

  @@index([templateId])
  @@index([clientId])
  @@index([leadId])
  @@index([status])
  @@index([createdAt])
  @@map("wizard_submissions")
}

// ============================================================
// DIGITAL BUSINESS CARD (NFC)
// ============================================================

model DigitalCard {
  id              String    @id @default(uuid())
  userId          String    @unique
  slug            String    @unique
  isEnabled       Boolean   @default(true)

  // Info professionale
  jobTitle        String?
  department      String?

  // Social links
  linkedinUrl     String?
  instagramUrl    String?
  twitterUrl      String?
  githubUrl       String?
  websiteUrl      String?
  whatsappNumber  String?
  facebookUrl     String?
  tiktokUrl       String?
  youtubeUrl      String?
  telegramUrl     String?

  // Card content
  cardBio         String?   @db.Text
  showWizards     Boolean   @default(false)

  // Booking
  showBooking      Boolean   @default(false)
  bookingDuration  Int       @default(30)
  bookingDaysAhead Int       @default(14)
  bookingStartHour Int       @default(9)
  bookingEndHour   Int       @default(18)

  // Analytics
  viewCount       Int       @default(0)
  lastViewedAt    DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([isEnabled])
  @@map("digital_cards")
}

// ============================================================
// LOGIN IP VERIFICATION (OTP)
// ============================================================

model TrustedIp {
  id         String   @id @default(uuid())
  userId     String
  ipAddress  String
  userAgent  String?  @db.Text
  label      String?
  lastUsedAt DateTime @default(now())
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, ipAddress])
  @@index([userId])
  @@map("trusted_ips")
}

model LoginOtp {
  id          String   @id @default(uuid())
  userId      String
  otpHash     String
  ipAddress   String
  userAgent   String?  @db.Text
  expiresAt   DateTime
  isUsed      Boolean  @default(false)
  attempts    Int      @default(0)
  maxAttempts Int      @default(5)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, ipAddress])
  @@map("login_otps")
}

// ============================================================
// KNOWLEDGE BASE
// ============================================================

model WikiPage {
  id          String     @id @default(uuid())
  title       String
  slug        String     @unique
  content     String     @db.Text
  excerpt     String?
  category    String     @default("general")
  tags        String[]   @default([])
  authorId    String
  isPublished Boolean    @default(false)
  sortOrder   Int        @default(0)
  parentId    String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  author      User       @relation(fields: [authorId], references: [id])
  parent      WikiPage?  @relation("WikiHierarchy", fields: [parentId], references: [id])
  children    WikiPage[] @relation("WikiHierarchy")

  @@index([authorId])
  @@index([category])
  @@index([slug])
  @@map("wiki_pages")
}


model ProjectLink {
  id          String   @id @default(uuid())
  projectId   String
  folderId    String?
  creatorId   String
  title       String
  url         String
  description String?  @db.Text
  tags        String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  folder  Folder?  @relation(fields: [folderId], references: [id], onDelete: SetNull)
  creator User     @relation("ProjectLinkCreator", fields: [creatorId], references: [id])

  @@index([projectId])
  @@index([folderId])
  @@index([creatorId])
  @@index([createdAt])
  @@map("project_links")
}

model MicrosoftToken {
  id            String    @id @default(uuid())
  userId        String    @unique
  accessToken   String    @db.Text
  refreshToken  String    @db.Text
  expiresAt     DateTime
  scope         String
  email         String?
  todoListId    String?
  webhookSubId  String?
  webhookExpiry DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("microsoft_tokens")
}

// ============================================================
// AI AGENT
// ============================================================

enum AiChannel {
  WEB
  WHATSAPP
  TELEGRAM
  API
}

enum AiRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL_RESULT
}

enum AiToolStatus {
  PENDING
  SUCCESS
  ERROR
  DENIED
}

model AiAgentConfig {
  id              String   @id @default(uuid())
  brandSlug       String   @unique
  name            String   @default("Assistente AI")
  systemPrompt    String?  @db.Text
  model           String   @default("claude-sonnet-4-6")
  temperature     Float    @default(0.7)
  maxTokens       Int      @default(4096)
  enabledTools    String[] @default([])
  welcomeMessage  String?  @db.Text
  metadata        Json?
  isActive        Boolean  @default(true)
  // Phase 1: Thinking
  enableThinking  Boolean  @default(true)
  thinkingEffort  String   @default("medium") // low | medium | high
  // Phase 2: Voice
  ttsProvider     String   @default("disabled") // disabled | openai | elevenlabs | cartesia
  ttsVoice        String?
  autoPlayVoice   Boolean  @default(false)
  // Phase 3: Conversational Voice Agent (ElevenLabs)
  voiceAgentId      String?
  voiceAgentEnabled Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([brandSlug])
  @@map("ai_agent_configs")
}

enum AiKnowledgeCategory {
  SERVICES
  PRICING
  PROCESSES
  TEAM
  FAQ
  OTHER
}

model AiKnowledgePage {
  id         String               @id @default(uuid())
  brandSlug  String
  title      String
  content    String               @db.Text
  category   AiKnowledgeCategory  @default(OTHER)
  isActive   Boolean              @default(true)
  sortOrder  Int                  @default(0)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  @@index([brandSlug, isActive])
  @@index([category])
  @@map("ai_knowledge_pages")
}

model AiConversation {
  id          String    @id @default(uuid())
  userId      String
  channel     AiChannel @default(WEB)
  title       String?
  summary     String?   @db.Text
  externalId  String?
  isArchived  Boolean   @default(false)
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages AiMessage[]

  @@index([userId])
  @@index([channel])
  @@index([externalId])
  @@index([createdAt])
  @@map("ai_conversations")
}

model AiMessage {
  id             String   @id @default(uuid())
  conversationId String
  role           AiRole
  content        String   @db.Text
  toolCalls      Json?
  attachments    Json?
  tokenInput     Int?
  tokenOutput    Int?
  latencyMs      Int?
  model          String?
  createdAt      DateTime @default(now())

  conversation   AiConversation   @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  toolExecutions AiToolExecution[]

  @@index([conversationId, createdAt])
  @@map("ai_messages")
}

model AiToolExecution {
  id         String       @id @default(uuid())
  messageId  String
  toolName   String
  input      Json
  output     Json?
  status     AiToolStatus @default(PENDING)
  durationMs Int?
  error      String?      @db.Text
  createdAt  DateTime     @default(now())

  message AiMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([toolName])
  @@index([status])
  @@index([createdAt])
  @@map("ai_tool_executions")
}

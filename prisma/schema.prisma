generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// AUTH & RBAC
// ============================================================

model User {
  id          String    @id @default(uuid())
  username    String    @unique
  email       String    @unique
  password    String
  firstName   String
  lastName    String
  avatarUrl   String?
  phone       String?
  bio         String?
  timezone    String?   @default("Europe/Rome")
  language    String?   @default("it")
  role          Role      @default(DEVELOPER)
  isActive      Boolean   @default(true)
  sectionAccess Json?
  lastLoginAt    DateTime?
  lastActiveAt   DateTime?
  lastIpAddress  String?
  createdAt      DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  refreshTokens    RefreshToken[]
  permissions      UserPermission[]
  workspaceMembers WorkspaceMember[]
  assignedTasks    Task[]          @relation("TaskAssignee")
  createdTasks     Task[]          @relation("TaskCreator")
  taskAssignments  TaskAssignment[] @relation("TaskAssignments")
  timeEntries      TimeEntry[]
  comments         Comment[]
  notifications    Notification[]
  activityLogs     ActivityLog[]
  createdQuotes    Quote[]         @relation("QuoteCreator")
  approvedQuotes   Quote[]         @relation("QuoteApprover")
  signatureRequests SignatureRequest[] @relation("SignatureRequester")
  ticketsAssigned  Ticket[]        @relation("TicketAssignee")
  ticketsCreated   Ticket[]        @relation("TicketCreator")
  wikiPageEdits    WikiPageVersion[]
  assetUploads     Asset[]
  reviewComments   ReviewComment[]
  clientPortal     Client?         @relation("ClientPortalUser")
  assignedLeads    Lead[]          @relation("LeadAssignee")
  googleToken      GoogleToken?
  chatChannels     ChatChannel[]   @relation("ChannelCreator")
  chatMemberships  ChatMember[]
  chatMessages     ChatMessage[]
  taskAttachments      TaskAttachment[]
  projectAttachments   ProjectAttachment[]
  pushSubscriptions    PushSubscription[]
  workSessions         WorkSession[]
  projectMemberships   ProjectMember[]
  trainingEnrollments  TrainingEnrollment[]
  trainingProgress     TrainingProgress[]
  trainingQuizAnswers  TrainingQuizAnswer[]
  trainingCertificates TrainingCertificate[]

  @@index([username])
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([lastActiveAt])
  @@map("users")
}

model GoogleToken {
  id           String   @id @default(uuid())
  userId       String   @unique
  accessToken  String   @db.Text
  refreshToken String   @db.Text
  expiresAt    DateTime
  scope        String
  email        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("google_tokens")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  isRevoked Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model UserPermission {
  id         String @id @default(uuid())
  userId     String
  module     String // "crm", "erp", "pm", "kb", "content", "support", "admin"
  permission String // "read", "write", "delete", "approve", "admin"
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, module, permission])
  @@index([userId])
  @@map("user_permissions")
}

enum Role {
  ADMIN
  MANAGER
  SALES
  PM
  DEVELOPER
  CONTENT
  SUPPORT
  CLIENT
}

// ============================================================
// WORKSPACES
// ============================================================

model Workspace {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  color       String   @default("#3B82F6")
  icon        String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members  WorkspaceMember[]
  projects Project[]

  @@index([slug])
  @@map("workspaces")
}

model WorkspaceMember {
  id          String        @id @default(uuid())
  workspaceId String
  userId      String
  role        WorkspaceRole @default(MEMBER)
  joinedAt    DateTime      @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_members")
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ============================================================
// CRM & ANAGRAFICA
// ============================================================

model Client {
  id           String       @id @default(uuid())
  companyName  String
  slug         String       @unique
  vatNumber    String?
  fiscalCode   String?
  pec          String?
  sdi          String?
  website      String?
  industry     String?
  source       String?
  status       ClientStatus @default(LEAD)
  notes        String?      @db.Text
  tags         String[]     @default([])
  totalRevenue Decimal      @default(0) @db.Decimal(12, 2)
  portalUserId String?      @unique
  portalUser   User?        @relation("ClientPortalUser", fields: [portalUserId], references: [id])
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  contacts        Contact[]
  interactions    Interaction[]
  projects        Project[]
  quotes          Quote[]
  tickets         Ticket[]
  documents       Document[]
  quoteTemplates  QuoteTemplate[]
  signatureRequests SignatureRequest[] @relation("SignatureClient")

  @@index([status])
  @@index([slug])
  @@map("clients")
}

enum ClientStatus {
  LEAD
  PROSPECT
  ACTIVE
  INACTIVE
  CHURNED
}

model Contact {
  id        String   @id @default(uuid())
  clientId  String
  firstName String
  lastName  String
  email     String?
  phone     String?
  role      String?
  isPrimary Boolean  @default(false)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client       Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  interactions Interaction[]

  @@index([clientId])
  @@index([email])
  @@map("contacts")
}

model Interaction {
  id        String          @id @default(uuid())
  clientId  String
  contactId String?
  type      InteractionType
  subject   String
  content   String?         @db.Text
  date      DateTime        @default(now())
  createdAt DateTime        @default(now())

  client  Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  contact Contact? @relation(fields: [contactId], references: [id])

  @@index([clientId])
  @@index([contactId])
  @@index([date])
  @@index([clientId, date])
  @@map("interactions")
}

enum InteractionType {
  CALL
  EMAIL
  MEETING
  NOTE
  WHATSAPP
  SOCIAL
}

model Lead {
  id         String   @id @default(cuid())
  name       String
  email      String
  company    String?
  phone      String?
  service    String?
  message    String   @db.Text
  source     String   @default("website")
  status     String   @default("NEW")
  notes      String?  @db.Text
  assigneeId String?
  assignee   User?    @relation("LeadAssignee", fields: [assigneeId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([status])
  @@index([assigneeId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@map("leads")
}

// ============================================================
// PROJECT MANAGEMENT
// ============================================================

model Project {
  id           String        @id @default(uuid())
  workspaceId  String
  clientId     String?
  name         String
  slug         String        @unique
  description  String?       @db.Text
  status       ProjectStatus @default(PLANNING)
  priority     Priority      @default(MEDIUM)
  startDate    DateTime?
  endDate      DateTime?
  deadline     DateTime?
  budgetAmount Decimal?      @db.Decimal(12, 2)
  budgetHours  Int?
  color        String        @default("#6366F1")
  isArchived   Boolean       @default(false)
  isInternal   Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  workspace    Workspace     @relation(fields: [workspaceId], references: [id])
  client       Client?       @relation(fields: [clientId], references: [id])
  tasks        Task[]
  milestones   Milestone[]
  documents    Document[]
  quotes       Quote[]
  tickets      Ticket[]
  assets       Asset[]
  chatChannels ChatChannel[]
  folders      Folder[]
  attachments  ProjectAttachment[]
  members      ProjectMember[]

  @@index([workspaceId])
  @@index([clientId])
  @@index([status])
  @@index([slug])
  @@index([isInternal])
  @@index([isArchived])
  @@index([workspaceId, status])
  @@index([clientId, status])
  @@index([createdAt])
  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(uuid())
  projectId String
  userId    String
  role      String   @default("MEMBER")
  joinedAt  DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_members")
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  REVIEW
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Milestone {
  id        String    @id @default(uuid())
  projectId String
  name      String
  dueDate   DateTime?
  status    String    @default("pending")
  sortOrder Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@index([projectId])
  @@map("milestones")
}

model Task {
  id             String     @id @default(uuid())
  projectId      String?
  milestoneId    String?
  parentId       String?
  assigneeId     String?
  creatorId      String
  folderId       String?
  title          String
  description    String?    @db.Text
  status         TaskStatus @default(TODO)
  priority       Priority   @default(MEDIUM)
  boardColumn    String     @default("todo")
  sortOrder      Int        @default(0)
  isPersonal     Boolean    @default(false)
  startDate      DateTime?
  dueDate        DateTime?
  completedAt    DateTime?
  estimatedHours   Float?
  tags             String[]   @default([])
  timerStartedAt   DateTime?
  timerUserId      String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  project    Project?   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  milestone  Milestone? @relation(fields: [milestoneId], references: [id])
  parent     Task?      @relation("TaskSubtasks", fields: [parentId], references: [id])
  subtasks   Task[]     @relation("TaskSubtasks")
  assignee   User?      @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator    User       @relation("TaskCreator", fields: [creatorId], references: [id])
  folder     Folder?    @relation(fields: [folderId], references: [id])
  timeEntries    TimeEntry[]
  comments       Comment[]
  assignments    TaskAssignment[]
  dependsOn      TaskDependency[] @relation("DependentTask")
  dependedOnBy   TaskDependency[] @relation("DependencyTask")
  attachments    TaskAttachment[]

  @@index([projectId])
  @@index([assigneeId])
  @@index([creatorId])
  @@index([status])
  @@index([isPersonal])
  @@index([milestoneId])
  @@index([parentId])
  @@index([boardColumn])
  @@index([folderId])
  @@index([projectId, status])
  @@index([assigneeId, status])
  @@index([creatorId, status])
  @@index([dueDate])
  @@index([priority])
  @@index([createdAt])
  @@index([updatedAt])
  @@map("tasks")
}

model TaskAssignment {
  id         String   @id @default(uuid())
  taskId     String
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation("TaskAssignments", fields: [userId], references: [id])
  role       String   @default("assignee")
  assignedAt DateTime @default(now())
  assignedBy String?

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
  @@map("task_assignments")
}

model TaskAttachment {
  id           String   @id @default(uuid())
  taskId       String
  uploadedById String
  fileName     String
  fileUrl      String
  fileSize     Int
  mimeType     String
  createdAt    DateTime @default(now())

  task       Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy User @relation(fields: [uploadedById], references: [id])

  @@index([taskId])
  @@map("task_attachments")
}

model TaskDependency {
  id          String @id @default(uuid())
  taskId      String
  dependsOnId String
  type        String @default("finish_to_start")

  task      Task @relation("DependentTask", fields: [taskId], references: [id], onDelete: Cascade)
  dependsOn Task @relation("DependencyTask", fields: [dependsOnId], references: [id], onDelete: Cascade)

  @@unique([taskId, dependsOnId])
  @@map("task_dependencies")
}

model Folder {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  description String?
  color       String   @default("#6366F1")
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project      Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks        Task[]
  attachments  ProjectAttachment[]
  chatChannels ChatChannel[]

  @@index([projectId])
  @@map("folders")
}

model ProjectAttachment {
  id           String   @id @default(uuid())
  projectId    String
  uploadedById String
  folderId     String?
  fileName     String
  fileUrl      String
  fileSize     Int
  mimeType     String
  driveFileId  String?
  createdAt    DateTime @default(now())

  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedBy User    @relation(fields: [uploadedById], references: [id])
  folder     Folder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([folderId])
  @@map("project_attachments")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  CANCELLED
}

model TimeEntry {
  id          String   @id @default(uuid())
  userId      String
  taskId      String?
  projectId   String?
  date        DateTime @db.Date
  hours       Float
  description String?
  billable    Boolean  @default(true)
  hourlyRate  Decimal? @db.Decimal(8, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User  @relation(fields: [userId], references: [id])
  task Task? @relation(fields: [taskId], references: [id])

  @@index([userId])
  @@index([taskId])
  @@index([date])
  @@index([userId, date])
  @@map("time_entries")
}

model WorkSession {
  id            String    @id @default(uuid())
  userId        String
  clockIn       DateTime  @default(now())
  clockOut      DateTime?
  lastHeartbeat DateTime  @default(now())
  durationMins  Int?
  notes         String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([clockIn])
  @@index([userId, clockIn])
  @@map("work_sessions")
}

// ============================================================
// ERP & FINANCE
// ============================================================

model Quote {
  id                 String      @id @default(uuid())
  clientId           String
  projectId          String?
  creatorId          String
  approverId         String?
  templateId         String?
  number             String      @unique
  title              String
  content            Json?
  status             QuoteStatus @default(DRAFT)
  subtotal           Decimal     @db.Decimal(12, 2)
  taxRate            Decimal     @default(22) @db.Decimal(5, 2)
  taxAmount          Decimal     @db.Decimal(12, 2)
  total              Decimal     @db.Decimal(12, 2)
  discount           Decimal     @default(0) @db.Decimal(12, 2)
  validUntil         DateTime?
  sentAt             DateTime?
  approvedAt         DateTime?
  rejectedAt         DateTime?
  notes              String?     @db.Text
  clientApproval     Boolean?
  clientApprovalDate DateTime?
  clientApprovalNote String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  client    Client          @relation(fields: [clientId], references: [id])
  project   Project?        @relation(fields: [projectId], references: [id])
  creator   User            @relation("QuoteCreator", fields: [creatorId], references: [id])
  approver  User?           @relation("QuoteApprover", fields: [approverId], references: [id])
  template  QuoteTemplate?  @relation("QuoteFromTemplate", fields: [templateId], references: [id])
  lineItems QuoteLineItem[]

  @@index([clientId])
  @@index([status])
  @@index([number])
  @@index([templateId])
  @@index([creatorId])
  @@index([projectId])
  @@index([clientId, status])
  @@index([createdAt])
  @@map("quotes")
}

model QuoteLineItem {
  id          String  @id @default(uuid())
  quoteId     String
  description String
  quantity    Float   @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(12, 2)
  sortOrder   Int     @default(0)

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@map("quote_line_items")
}

enum QuoteStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  EXPIRED
  INVOICED
}

model Expense {
  id          String   @id @default(uuid())
  category    String
  description String
  amount      Decimal  @db.Decimal(10, 2)
  date        DateTime @db.Date
  receipt     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
  @@index([category])
  @@map("expenses")
}

// ============================================================
// KNOWLEDGE BASE
// ============================================================

model WikiPage {
  id           String   @id @default(uuid())
  parentId     String?
  workspaceId  String?
  title        String
  slug         String
  content      Json?
  contentText  String?  @db.Text
  category     String   @default("general")
  icon         String?
  coverUrl     String?
  sortOrder    Int      @default(0)
  isPublished  Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  parent   WikiPage?         @relation("WikiHierarchy", fields: [parentId], references: [id])
  children WikiPage[]        @relation("WikiHierarchy")
  versions WikiPageVersion[]
  comments Comment[]         @relation("WikiPageComments")

  @@unique([parentId, slug])
  @@index([parentId])
  @@index([workspaceId])
  @@index([category])
  @@index([slug])
  @@map("wiki_pages")
}

model WikiPageVersion {
  id         String   @id @default(uuid())
  pageId     String
  editorId   String
  content    Json?
  version    Int
  changeNote String?
  createdAt  DateTime @default(now())

  page   WikiPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  editor User     @relation(fields: [editorId], references: [id])

  @@index([pageId])
  @@map("wiki_page_versions")
}

// ============================================================
// CONTENT & CREATIVE
// ============================================================

model Asset {
  id           String   @id @default(uuid())
  projectId    String?
  uploadedById String
  fileName     String
  fileUrl      String
  fileSize     Int
  mimeType     String
  category     String   @default("general")
  tags         String[] @default([])
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project    Project?      @relation(fields: [projectId], references: [id])
  uploadedBy User          @relation(fields: [uploadedById], references: [id])
  reviews    AssetReview[]

  @@index([projectId])
  @@index([category])
  @@map("assets")
}

model AssetReview {
  id        String       @id @default(uuid())
  assetId   String
  status    ReviewStatus @default(PENDING)
  dueDate   DateTime?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  asset    Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  comments ReviewComment[]

  @@index([assetId])
  @@index([status])
  @@map("asset_reviews")
}

model ReviewComment {
  id        String   @id @default(uuid())
  reviewId  String
  authorId  String
  content   String   @db.Text
  timestamp Float?
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now())

  review AssetReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  author User        @relation(fields: [authorId], references: [id])

  @@index([reviewId])
  @@map("review_comments")
}

enum ReviewStatus {
  PENDING
  IN_REVIEW
  APPROVED
  CHANGES_REQUESTED
}

model SocialPost {
  id          String   @id @default(uuid())
  projectId   String?
  platform    String
  content     String   @db.Text
  mediaUrls   String[] @default([])
  scheduledAt DateTime?
  publishedAt DateTime?
  status      String   @default("draft")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([platform])
  @@index([scheduledAt])
  @@index([status])
  @@map("social_posts")
}

// ============================================================
// SUPPORT
// ============================================================

model Ticket {
  id          String       @id @default(uuid())
  clientId    String
  projectId   String?
  creatorId   String
  assigneeId  String?
  number      String       @unique
  subject     String
  description String       @db.Text
  status      TicketStatus @default(OPEN)
  priority    Priority     @default(MEDIUM)
  category    String       @default("general")
  resolvedAt  DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  client   Client   @relation(fields: [clientId], references: [id])
  project  Project? @relation(fields: [projectId], references: [id])
  creator  User     @relation("TicketCreator", fields: [creatorId], references: [id])
  assignee User?    @relation("TicketAssignee", fields: [assigneeId], references: [id])
  comments Comment[]

  @@index([clientId])
  @@index([assigneeId])
  @@index([status])
  @@index([number])
  @@index([creatorId])
  @@index([projectId])
  @@index([clientId, status])
  @@index([createdAt])
  @@map("tickets")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CLIENT
  RESOLVED
  CLOSED
}

// ============================================================
// CROSS-CUTTING
// ============================================================

model Comment {
  id         String   @id @default(uuid())
  authorId   String
  taskId     String?
  ticketId   String?
  wikiPageId String?
  content    String   @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  author   User      @relation(fields: [authorId], references: [id])
  task     Task?     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  ticket   Ticket?   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  wikiPage WikiPage? @relation("WikiPageComments", fields: [wikiPageId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([ticketId])
  @@index([wikiPageId])
  @@index([authorId])
  @@index([createdAt])
  @@map("comments")
}

model Document {
  id              String   @id @default(uuid())
  clientId        String?
  projectId       String?
  name            String
  fileUrl         String
  fileSize        Int?
  mimeType        String?
  category        String   @default("general")
  isClientVisible Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  client  Client?  @relation(fields: [clientId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])

  @@index([clientId])
  @@index([projectId])
  @@index([category])
  @@index([isClientVisible])
  @@map("documents")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@map("push_subscriptions")
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String
  action     String
  entityType String
  entityId   String
  metadata   Json?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("activity_logs")
}

// ============================================================
// TEAM CHAT
// ============================================================

model ChatChannel {
  id          String      @id @default(uuid())
  name        String
  slug        String      @unique
  description String?
  type        ChannelType @default(PUBLIC)
  projectId   String?
  folderId    String?
  createdById String
  isArchived  Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  createdBy User          @relation("ChannelCreator", fields: [createdById], references: [id])
  project   Project?      @relation(fields: [projectId], references: [id])
  folder    Folder?       @relation(fields: [folderId], references: [id], onDelete: SetNull)
  members   ChatMember[]
  messages  ChatMessage[]

  @@index([slug])
  @@index([type])
  @@index([createdById])
  @@index([projectId])
  @@index([folderId])
  @@map("chat_channels")
}

model ChatMember {
  id         String         @id @default(uuid())
  channelId  String
  userId     String
  role       ChatMemberRole @default(MEMBER)
  lastReadAt DateTime?
  joinedAt   DateTime       @default(now())

  channel ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@index([channelId])
  @@index([userId])
  @@map("chat_members")
}

model ChatMessage {
  id        String          @id @default(uuid())
  channelId String
  authorId  String
  content   String          @db.Text
  type      ChatMessageType @default(TEXT)
  metadata  Json?
  editedAt  DateTime?
  deletedAt DateTime?
  createdAt DateTime        @default(now())

  channel ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  author  User        @relation(fields: [authorId], references: [id])

  @@index([channelId, createdAt])
  @@index([authorId])
  @@map("chat_messages")
}

enum ChannelType {
  PUBLIC
  PRIVATE
  DIRECT
  PROJECT
}

enum ChatMemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum ChatMessageType {
  TEXT
  SYSTEM
  FILE_LINK
}

model CompanyProfile {
  id             String  @id @default(cuid())
  ragioneSociale String
  partitaIva     String
  codiceFiscale  String?
  indirizzo      String
  cap            String
  citta          String
  provincia      String  @db.VarChar(2)
  nazione        String  @default("IT")
  regimeFiscale  String  @default("RF01")
  iban           String?
  pec            String?
  telefono       String?
  email          String?
  logoUrl        String?
  siteUrl        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("company_profiles")
}

// ============================================================
// QUOTE TEMPLATES (FASE 1)
// ============================================================

model QuoteTemplate {
  id               String   @id @default(uuid())
  name             String
  slug             String   @unique
  description      String?
  isGlobal         Boolean  @default(true)
  clientId         String?
  creatorId        String
  logoUrl          String?
  primaryColor     String   @default("#3B82F6")
  secondaryColor   String   @default("#1E293B")
  headerHtml       String?  @db.Text
  footerHtml       String?  @db.Text
  sections         Json?    // [{title, content, sortOrder}]
  numberPrefix     String   @default("Q")
  numberFormat     String   @default("{PREFIX}-{YYYY}-{NNN}")
  defaultTaxRate   Decimal  @default(22) @db.Decimal(5, 2)
  defaultDiscount  Decimal  @default(0) @db.Decimal(12, 2)
  defaultNotes     String?  @db.Text
  defaultValidDays Int      @default(30)
  termsAndConditions String? @db.Text
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  client           Client?  @relation(fields: [clientId], references: [id])
  lineItems        QuoteTemplateLineItem[]
  quotes           Quote[]  @relation("QuoteFromTemplate")

  @@index([clientId])
  @@index([isGlobal])
  @@map("quote_templates")
}

model QuoteTemplateLineItem {
  id          String  @id @default(uuid())
  templateId  String
  description String
  quantity    Float   @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  sortOrder   Int     @default(0)

  template    QuoteTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("quote_template_line_items")
}

// ============================================================
// SIGNATURE / OTP (FASE 3)
// ============================================================

model SignatureRequest {
  id              String    @id @default(uuid())
  documentType    String    // "QUOTE" | "CONTRACT" | "CUSTOM"
  documentId      String?
  documentTitle   String
  documentUrl     String    // PDF originale su MinIO
  signedPdfUrl    String?   // PDF firmato
  requesterId     String
  signerName      String
  signerEmail     String
  signerPhone     String?
  signerClientId  String?
  status          String    @default("PENDING") // PENDING, OTP_SENT, SIGNED, DECLINED, EXPIRED, CANCELLED
  expiresAt       DateTime
  signedAt        DateTime?
  declineReason   String?
  message         String?   @db.Text
  accessToken     String    @unique
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  requester       User      @relation("SignatureRequester", fields: [requesterId], references: [id])
  signerClient    Client?   @relation("SignatureClient", fields: [signerClientId], references: [id])
  otpAttempts     SignatureOtp[]
  auditTrail      SignatureAudit[]

  @@index([status])
  @@index([signerEmail])
  @@index([accessToken])
  @@index([requesterId])
  @@index([signerClientId])
  @@index([createdAt])
  @@map("signature_requests")
}

model SignatureOtp {
  id          String   @id @default(uuid())
  requestId   String
  otpHash     String   // bcrypt hash, MAI in chiaro
  channel     String   @default("email")
  sentTo      String
  expiresAt   DateTime
  isUsed      Boolean  @default(false)
  attempts    Int      @default(0)
  maxAttempts Int      @default(5)
  createdAt   DateTime @default(now())

  request     SignatureRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@map("signature_otps")
}

model SignatureAudit {
  id        String   @id @default(uuid())
  requestId String
  action    String   // "created", "otp_sent", "otp_verified", "signed", "declined", "viewed"
  ipAddress String?
  userAgent String?  @db.Text
  metadata  Json?
  createdAt DateTime @default(now())

  request   SignatureRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@map("signature_audits")
}

// ============================================================
// WIZARD COMMERCIALE (FASE 4)
// ============================================================

model WizardTemplate {
  id                 String   @id @default(uuid())
  name               String
  slug               String   @unique
  description        String?  @db.Text
  category           String   @default("general")
  isSystem           Boolean  @default(false)
  status             String   @default("DRAFT") // DRAFT, PUBLISHED, ARCHIVED
  creatorId          String
  allowSaveProgress  Boolean  @default(true)
  showProgressBar    Boolean  @default(true)
  completionMessage  String?  @db.Text
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  steps              WizardStep[]
  submissions        WizardSubmission[]

  @@index([category])
  @@index([status])
  @@index([slug])
  @@map("wizard_templates")
}

model WizardStep {
  id          String  @id @default(uuid())
  templateId  String
  title       String
  description String?
  sortOrder   Int     @default(0)
  condition   Json?   // {fieldId, operator, value}

  template    WizardTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  fields      WizardField[]

  @@index([templateId])
  @@map("wizard_steps")
}

model WizardField {
  id           String  @id @default(uuid())
  stepId       String
  label        String
  name         String
  type         String  @default("TEXT") // TEXT, TEXTAREA, EMAIL, PHONE, NUMBER, SELECT, MULTISELECT, RADIO, CHECKBOX, DATE, FILE, RATING, SCALE
  placeholder  String?
  helpText     String?
  isRequired   Boolean @default(false)
  sortOrder    Int     @default(0)
  options      Json?   // [{label, value}] per SELECT/RADIO
  validation   Json?   // {min, max, minLength, maxLength, pattern}
  defaultValue String?
  condition    Json?
  crmMapping   String? // "client.companyName", "contact.email", ecc.

  step         WizardStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([stepId])
  @@map("wizard_fields")
}

model WizardSubmission {
  id             String    @id @default(uuid())
  templateId     String
  clientId       String?
  leadId         String?
  submitterId    String?
  submitterName  String?
  submitterEmail String?
  status         String    @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, ABANDONED
  currentStep    Int       @default(0)
  answers        Json      @default("{}")
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  template       WizardTemplate @relation(fields: [templateId], references: [id])

  @@index([templateId])
  @@index([clientId])
  @@index([leadId])
  @@index([status])
  @@index([createdAt])
  @@map("wizard_submissions")
}

// ============================================================
// TRAINING & FORMAZIONE
// ============================================================

enum TrainingType {
  INTERNAL
  USER
}

enum TrainingDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum ProtectionLevel {
  NONE
  WATERMARK
  WATERMARK_DETECT
}

enum LessonContentType {
  TEXT
  VIDEO
  QUIZ
  MIXED
}

enum QuizType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  TRUE_FALSE
}

enum EnrollmentStatus {
  IN_PROGRESS
  COMPLETED
}

model TrainingCategory {
  id          String       @id @default(uuid())
  name        String
  slug        String       @unique
  description String?
  icon        String?
  type        TrainingType @default(USER)
  sortOrder   Int          @default(0)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  courses TrainingCourse[]

  @@index([type])
  @@index([sortOrder])
  @@map("training_categories")
}

model TrainingCourse {
  id              String             @id @default(uuid())
  categoryId      String
  title           String
  slug            String             @unique
  description     String?            @db.Text
  coverUrl        String?
  difficulty      TrainingDifficulty @default(BEGINNER)
  protectionLevel ProtectionLevel    @default(NONE)
  allowedRoles    Role[]             @default([])
  estimatedMins   Int?
  isPublished     Boolean            @default(false)
  sortOrder       Int                @default(0)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  category    TrainingCategory     @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  lessons     TrainingLesson[]
  enrollments TrainingEnrollment[]

  @@index([categoryId])
  @@index([slug])
  @@index([isPublished])
  @@index([difficulty])
  @@map("training_courses")
}

model TrainingLesson {
  id          String            @id @default(uuid())
  courseId     String
  title       String
  slug        String
  content     Json?
  contentText String?           @db.Text
  contentType LessonContentType @default(TEXT)
  videoUrl    String?
  videoDurationSecs Int?
  sortOrder   Int               @default(0)
  isPublished Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  course      TrainingCourse       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  attachments TrainingAttachment[]
  quizzes     TrainingQuiz[]
  progress    TrainingProgress[]

  @@unique([courseId, slug])
  @@index([courseId])
  @@index([sortOrder])
  @@map("training_lessons")
}

model TrainingAttachment {
  id        String   @id @default(uuid())
  lessonId  String
  fileName  String
  fileUrl   String
  fileSize  Int
  mimeType  String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  lesson TrainingLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@map("training_attachments")
}

model TrainingQuiz {
  id            String   @id @default(uuid())
  lessonId      String
  question      String   @db.Text
  type          QuizType @default(SINGLE_CHOICE)
  options       Json
  correctAnswer Json
  explanation   String?  @db.Text
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  lesson  TrainingLesson      @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  answers TrainingQuizAnswer[]

  @@index([lessonId])
  @@map("training_quizzes")
}

model TrainingEnrollment {
  id          String           @id @default(uuid())
  userId      String
  courseId     String
  status      EnrollmentStatus @default(IN_PROGRESS)
  progress    Float            @default(0)
  completedAt DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  course TrainingCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@map("training_enrollments")
}

model TrainingProgress {
  id               String   @id @default(uuid())
  userId           String
  lessonId         String
  timeSpentSecs    Int      @default(0)
  videoProgressPct Float    @default(0)
  isCompleted      Boolean  @default(false)
  completedAt      DateTime?
  lastAccessedAt   DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson TrainingLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@map("training_progress")
}

model TrainingQuizAnswer {
  id        String   @id @default(uuid())
  userId    String
  quizId    String
  answer    Json
  isCorrect Boolean
  score     Float    @default(0)
  attempt   Int      @default(1)
  createdAt DateTime @default(now())

  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz TrainingQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@index([userId, quizId])
  @@map("training_quiz_answers")
}

model TrainingCertificate {
  id          String   @id @default(uuid())
  userId      String
  courseId     String
  certificateUrl String?
  issuedAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@map("training_certificates")
}

model TrainingSecurityLog {
  id        String   @id @default(uuid())
  userId    String
  lessonId  String?
  courseId   String?
  event     String
  metadata  Json?
  ipAddress String?
  userAgent String?  @db.Text
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([lessonId])
  @@index([event])
  @@index([createdAt])
  @@map("training_security_logs")
}

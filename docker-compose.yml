services:
  app:
    container_name: ${APP_CONTAINER_NAME:-fodi-os_app}
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - DATABASE_URL=${DATABASE_URL}
        - NEXT_PUBLIC_VAPID_PUBLIC_KEY=${NEXT_PUBLIC_VAPID_PUBLIC_KEY}
        - NEXT_PUBLIC_BRAND_NAME=${NEXT_PUBLIC_BRAND_NAME:-FODI OS}
        - NEXT_PUBLIC_BRAND_SLUG=${NEXT_PUBLIC_BRAND_SLUG:-fodi}
        - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL:-https://os.fodisrl.it}
        - NEXT_PUBLIC_BRAND_LOGO_DARK=${NEXT_PUBLIC_BRAND_LOGO_DARK:-/brands/fodi/logo-dark.png}
        - NEXT_PUBLIC_BRAND_LOGO_LIGHT=${NEXT_PUBLIC_BRAND_LOGO_LIGHT:-/brands/fodi/logo-light.png}
        - BRAND_NAME=${BRAND_NAME:-FODI OS}
        - BRAND_SLUG=${BRAND_SLUG:-fodi}
        - BRAND_COMPANY=${BRAND_COMPANY:-FODI S.r.l.}
        - BRAND_DESCRIPTION=${BRAND_DESCRIPTION:-Piattaforma di gestione aziendale}
        - BRAND_LOGO_DARK=${BRAND_LOGO_DARK:-/brands/fodi/logo-dark.png}
        - BRAND_LOGO_LIGHT=${BRAND_LOGO_LIGHT:-/brands/fodi/logo-light.png}
        - BRAND_STORAGE_URL=${BRAND_STORAGE_URL:-https://storage.fodivps2.cloud/fodi-os-assets/tutorials}
        - NEXT_PUBLIC_BRAND_STORAGE_URL=${NEXT_PUBLIC_BRAND_STORAGE_URL:-https://storage.fodivps2.cloud/fodi-os-assets/tutorials}
    restart: unless-stopped
    env_file:
      - .env.docker
    volumes:
      - ./certs:/app/certs:ro
    networks:
      - traefik-public
      - panel-internal
    labels:
      - traefik.enable=true
      # Production router
      - traefik.http.routers.${APP_NAME:-fodi-os}.rule=Host(`${APP_DOMAIN:-os.fodisrl.it}`)
      - traefik.http.routers.${APP_NAME:-fodi-os}.entrypoints=websecure
      - traefik.http.routers.${APP_NAME:-fodi-os}.tls=${APP_TLS:-true}
      - traefik.http.routers.${APP_NAME:-fodi-os}.tls.certresolver=${APP_TLS_RESOLVER:-}
      - traefik.http.routers.${APP_NAME:-fodi-os}.middlewares=${APP_NAME:-fodi-os}-retry@docker,security-headers@file
      - traefik.http.routers.${APP_NAME:-fodi-os}.service=${APP_NAME:-fodi-os}
      # Retry middleware
      - traefik.http.middlewares.${APP_NAME:-fodi-os}-retry.retry.attempts=3
      - traefik.http.middlewares.${APP_NAME:-fodi-os}-retry.retry.initialinterval=200ms
      # Service
      - traefik.http.services.${APP_NAME:-fodi-os}.loadbalancer.server.port=3000
      - traefik.docker.network=traefik-public
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1024M

networks:
  traefik-public:
    external: true
  panel-internal:
    external: true
